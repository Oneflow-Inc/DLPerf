# OneFlow Benchmark test tools

## `ansible_execute.sh`
è¯¥è„šæœ¬ç”¨äºå¸®åŠ©åœ¨é›†ç¾¤ä¸­æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚`ls`ã€‚è„šæœ¬ä¾èµ–ä¸€ä¸ªåä¸º`hosts`çš„æ–‡ä»¶ï¼Œé‡Œé¢ä¿å­˜äº†é›†ç¾¤çš„ipåˆ—è¡¨ï¼Œæ¯”å¦‚ï¼š
```
# ip list
10.105.0.32
10.105.0.33
10.105.0.34
10.105.0.35
```

è¯¥è„šæœ¬ä¾èµ–ä¸‰ä¸ªå‚æ•°ï¼š
- `--cmd`: å¾…æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¸é€‰å°±æ‰§è¡Œ`ls`å‘½ä»¤
- `--num-nodes`: éœ€è¦åœ¨å‡ å°èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œä¸é€‰è¡¨ç¤ºåœ¨æ‰€æœ‰hostséƒ½æ‰§è¡Œ
- `--password`: ansibleæ‰§è¡Œsshè®¿é—®å…¶ä»–èŠ‚ç‚¹æ—¶æ‰€éœ€è¦é”®å…¥çš„å¯†ç ï¼Œä¸é€‰éœ€è¦é…ç½®å…å¯†ç™»é™†

è„šæœ¬çš„å·¥ä½œåŸç†ï¼šè„šæœ¬é¦–å…ˆè·å–è¾“å…¥çš„å‚æ•°ï¼Œç„¶åæ ¹æ®`hosts`æ–‡ä»¶åˆ›å»ºä¸€ä¸ª`inventory`æ–‡ä»¶ä¾›`ansible`å‘½ä»¤ä½¿ç”¨ï¼Œ`inventory`ä¸­æ ¹æ®`--num-nodes`é™å®šäº†èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœæœ‰é…`--password`å°±ä¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¾ç½®`ansible_ssh_pass`ï¼Œæœ€åæ‰§è¡Œ`--cmd`æŒ‡å®šçš„å‘½ä»¤ã€‚

ä¾‹å­ğŸŒ°ï¼š
```bash
./ansible_execute.sh \
  --password=******** \
  --cmd="python3 -m pip install -U /path/to/oneflow.whl"
```
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯`--cmd`çš„å€¼è¢«å¼•å·åŒ…è£¹ï¼Œä¸ç„¶è§£æä¼šå‡ºé—®é¢˜ï¼›å¦å¤–`python3`é€šå¸¸ä¼šè¢«ç»å¯¹è·¯å¾„æ›¿æ¢ï¼Œæ¯”å¦‚`/home/tianshu/miniconda3/bin/python3`ä»¥é¿å…å„ä¸ªæœºå™¨çš„ç¯å¢ƒä¸ä¸€è‡´ã€‚

## `run_resnet_tests.py`
è¯¥è„šæœ¬ç”¨äºåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸€ç»„resnet50çš„æ€§èƒ½æµ‹è¯•ã€‚åŒæ ·ä¾èµ–å‰é¢æåˆ°çš„`hosts`æ–‡ä»¶ã€‚

è¯¥è„šæœ¬ä¾èµ–ä¸‹é¢çš„å‚æ•°ï¼š
- `--python_bin`: pythonå¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®ï¼Œæ¯”å¦‚`/home/tianshu/miniconda3/bin/python3`
- `--script`: resnet50è„šæœ¬çš„ä½ç½®ï¼Œå³[OneFlow-Benchmark](https://github.com/Oneflow-Inc/OneFlow-Benchmark)é¡¹ç›®`Classification/cnns/of_cnn_train_val.py`æ–‡ä»¶çš„ä½ç½®
- `--data_dir`: imagenet ofrecordæ ¼å¼æ•°æ®é›†çš„ä½ç½®
- `--log_dir`: å¾…è¾“å‡ºlogçš„ä¿å­˜ç›®å½•
- `--repeat`: è¿™ç»„æµ‹è¯•é‡å¤æ‰§è¡Œçš„æ¬¡æ•°

ä¾‹å­ğŸŒ°ï¼š
```bash
python3 run_resnet_tests.py \
  --password=******** \
  --python_bin=`which python3` \
  --script=/nfs/git-repos/OneFlow-Benchmark/Classification/cnns/of_cnn_train_val.py \
  --data_dir=/nfs/data/imagenet/ofrecord \
  --log_dir=log
```

### è„šæœ¬å®ç°è¯´æ˜
#### `OfResnetTest`ç±»
è¯¥ç±»ç»§æ‰¿è‡ª`GroupTest`ï¼Œè¯¦è§`group_test.py`ã€‚å¯¹äºä¸€ç»„æµ‹è¯•æ¥è¯´ï¼Œéœ€è¦çŸ¥é“ï¼š
- æµ‹è¯•éœ€è¦ä½¿ç”¨çš„`python_bin`çš„ä½ç½®
- å¾…æµ‹è¯•çš„è„šæœ¬`script`
- æµ‹è¯•è„šæœ¬æ‰€éœ€çš„å‚æ•°`args`
- æµ‹è¯•æ˜¯éœ€è¦è®¾ç½®çš„ç¯å¢ƒå˜é‡`envs`
- æµ‹è¯•éœ€è¦ç”¨åˆ°çš„ä¸»æœºipåˆ—è¡¨`hosts`
- å·²ç»æµ‹è¯•ç»“æœä¿å­˜çš„ç›®å½•`log_dir`

##### æµ‹è¯•ç­–ç•¥çŸ©é˜µ strategy.matrix
`GroupTest`çš„æ ¸å¿ƒæ¦‚å¿µå°±æµ‹è¯•ç­–ç•¥çŸ©é˜µ`metrix`ï¼Œæƒ³æ³•æ¥è‡ª[github workflow strategy](https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idstrategy)ã€‚æ¯ä¸ªæµ‹è¯•æ¡ˆä¾‹ç‹¬ç‰¹çš„é…ç½®å€¼ä»¥å­—å…¸çš„å½¢å¼å­˜å‚¨åœ¨çŸ©é˜µï¼ˆå…¶å®æ˜¯ä¸€ä¸ª`list`ï¼‰ä¸­ï¼Œæµ‹è¯•æ—¶éå†è¯¥çŸ©é˜µï¼Œé€ä¸ªæ‰§è¡Œæµ‹è¯•ã€‚`GroupTest`æä¾›äº†`append_matrix`æ¥å£å¸®åŠ©ç”ŸæˆçŸ©é˜µã€‚

##### `__call__`ä¸`run_once`å‡½æ•°
`GroupTest`é‡è½½äº†`__call__`å‡½æ•°ç”¨æ¥ç”Ÿæˆå¯ä»¥è¿è¡Œçš„å‘½ä»¤åˆ—è¡¨`cmds`ã€‚å…¶ä¸­æ ¹æ®`repeat`æ¥å†³å®šè¦æ‰§è¡Œå‡ æ¬¡`run_once`ã€‚

`run_once`è´Ÿè´£æ ¹æ®`matrix`ç”Ÿæˆä¸€ç»„æµ‹è¯•å‘½ä»¤ã€‚

##### å‘½åè§„åˆ™ `naming_rule`
`get_log_name`è´Ÿè´£æ ¹æ®æµ‹è¯•çš„ä¸€ç»„å‚æ•°ç”Ÿæˆç‰¹å®šçš„æ—¥å¿—æ–‡ä»¶åã€‚è€ƒè™‘åˆ°å‚æ•°åç§°ä¸€èˆ¬éƒ½æ¯”è¾ƒé•¿ï¼Œè€Œä¸”å¤§éƒ¨åˆ†å‚æ•°éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å®šä¹‰äº†ä¸€ä¸ªå­—å…¸`naming_rule`ï¼Œkeyæ˜¯å‚æ•°åï¼Œvalueæ˜¯ç¼©å†™ï¼Œåªæœ‰å­—å…¸é‡Œçš„å‚æ•°å‚ä¸å‘½åï¼Œæ¯”å¦‚ï¼š
```python
naming_rule = {
    'num_nodes': 'n',
    'gpu_num_per_node': 'g',
    'batch_size_per_device': 'b',
    'use_fp16': 'amp',
}
```

`set_log_naming_rule`ç”¨æ¥è®¾ç½®å‘½åè§„åˆ™ã€‚

#### `init_tests`
å‰é¢ä»‹ç»çš„`GroupTest`ç±»ï¼Œ`init_tests`å°±æ˜¯æ„é€ ç»„æµ‹è¯•ç±»å¯¹è±¡çš„å‡½æ•°ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š
- `envs`
- `default_args`: æ¯ä¸ªæµ‹è¯•éƒ½åŒ…æ‹¬çš„ç¼ºçœå‚æ•°
- `runs_on = [[1, 1], [1, 8], [2, 8], [4, 8]]`: æµ‹è¯•éœ€è¦ä½¿ç”¨çš„èµ„æºï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªä¸¤å…ƒåˆ—è¡¨ï¼ˆtupleä¹Ÿè¡Œï¼‰ï¼Œä»£è¡¨äº†èŠ‚ç‚¹æ•°å’Œæ¯ä¸ªèŠ‚ç‚¹çš„å¡æ•°ã€‚æ¯”å¦‚è¿™é‡Œå¯¹åº”ç€1æœº1å¡ã€1æœº8å¡ã€2æœº8å¡ã€4æœº8å¡ã€‚
- `for run_on in runs_on`è¿™ä¸ªå¾ªç¯å°±æ˜¯ä¸ºäº†ç»™ä¸åŒçš„è®¾å¤‡é…ç½®è®¾ç½®ä¸åŒçš„å‚æ•°ã€‚å¦å¤–å…¶ä¸­ï¼Œæ˜¯å¦å¼€å¯æ··åˆç²¾åº¦é€‰é¡¹ï¼ˆ`use_fp16`ï¼‰è¿˜éœ€è¦é…ç½®ä¸åŒçš„batch sizeã€‚

å…¶å®è¿™é‡Œå¯ä»¥æ˜¯å¾ˆçµæ´»çš„ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®æµ‹è¯•éœ€æ±‚ç»„ç»‡æµ‹è¯•å‚æ•°ï¼Œæ‰©å±•`matrix`ã€‚

#### ç”Ÿæˆæµ‹è¯•å‘½ä»¤
`cmds = rn50(FLAGS.repeat)` åªæ˜¯ç”Ÿæˆäº†ä¸€ç»„æµ‹è¯•å‘½ä»¤ï¼Œå¹¶ä¸çœŸæ­£æ‰§è¡Œæµ‹è¯•ã€‚`cmds`æ˜¯ä¸€ä¸ªlistï¼Œæ¯ä¸ªå…ƒç´ ç”±ä¸¤ä¸ªå­å…ƒç´ ç»„æˆï¼šæ‰§è¡Œè¯¥å‘½ä»¤çš„èŠ‚ç‚¹æ•°`num_nodes`å’Œå‘½ä»¤`cmd`æœ¬èº«ã€‚

#### æ‰§è¡Œæµ‹è¯•
`exec_cmd`æ˜¯çœŸæ­£çš„æ‰§è¡ŒæŸä¸€é¡¹æµ‹è¯•ã€‚
æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦æ ¹æ®èŠ‚ç‚¹æ•°å…ˆç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„`inventory`æ–‡ä»¶ã€‚ç„¶åæŠŠæµ‹è¯•å‘½ä»¤ä¿å­˜æˆä¸€ä¸ªä¸´æ—¶çš„shellè„šæœ¬æ–‡ä»¶`tmp_run.sh`ï¼Œä¸»è¦æ˜¯å› ä¸ºä¸ä¿å­˜ä¸´æ—¶æ–‡ä»¶æ€»æ•°æŠ¥é”™ï¼Œæ²¡æ‰¾åˆ°åŸå› ã€‚ç„¶åç”Ÿæˆansibleå‘½ä»¤ï¼Œé€šè¿‡`os.system`çš„æ–¹å¼æ‰§è¡Œã€‚

## `run_bert_tests.py`
ä¸`run_resnet_tests.py`ç±»ä¼¼ã€‚
ä¾‹å­ğŸŒ°ï¼š
```python
python3 run_bert_tests.py \
  --password=******** \
  --python_bin=`which python3` \
  --script=/nfs/git-repos/OneFlow-Benchmark/LanguageModeling/BERT/run_pretraining.py \
  --data_dir=/nfs/data/wiki_seq_len_128 \
  --log_dir=log
```

## ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
`generate_test_results.py`è´Ÿè´£ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šï¼Œå®ƒä¾èµ–ä¸‹é¢ä¸€äº›å‚æ•°ï¼š
- `--log_dir`: ä¿å­˜æ—¥å¿—çš„ç›®å½•åœ°å€
- `--endswith`: æ—¥å¿—çš„åç¼€ï¼Œç¼ºçœæ˜¯`.log`
- `--contains`: ç”¨äºè¿‡æ»¤æ—¥å¿—ç”¨çš„å­—ç¬¦ä¸²ï¼Œé‡‡ç”¨åªåŒ…å«æ­¤å­—ç¬¦ä¸²çš„æ—¥å¿—æ–‡ä»¶
- `--output`: æµ‹è¯•æŠ¥å‘Šç»“æœè¾“å‡ºçš„æ–‡ä»¶åï¼Œç›®å‰æ˜¯`;`åˆ†å‰²çš„csvæ–‡ä»¶
- `--type`: æ—¥å¿—ç±»å‹ï¼Œç›®å‰æ”¯æŒ`cnn`å’Œ`bert`ä¸¤ç§ç±»å‹ï¼Œç¼ºçœæ˜¯`cnn`
- `--start_iter`å’Œ`--end_iter`: ç›®å‰çš„æ—¥å¿—ä¸­ä¼šæ‰“å°æ—¶é—´æˆ³ï¼Œé€‰å–ä¸¤ä¸ªç‰¹å®šçš„iteræ—¶é—´æˆ³æ¥è®¡ç®—ååï¼ˆthroughputï¼‰å’Œbatchæ—¶å»¶ï¼ˆlatencyï¼‰ã€‚
- `--master_ip`: ç›®å‰åªæå–ä¸»æœºçš„æ€§èƒ½æ•°æ®ï¼Œè¿™é‡Œéœ€è¦æŒ‡å®šä¸€ä¸‹ä¸»æœºçš„ipï¼Œè¯¥ipä¼šè¢«ç¼–å…¥æŸ¥è¯¢æ¶ˆæ¯æŸ¥è¯¢`--start_iter`å’Œ`--end_iter`æ—¶é—´æ®µå†…è¯¥èŠ‚ç‚¹çš„æ€§èƒ½æŒ‡æ ‡ã€‚

ä¾‹å­ğŸŒ°ï¼š
1. æå–resnet50çš„æµ‹è¯•ç»“æœ
```bash
python3 generate_test_results.py --contains=A100-node26
```
2. æå–bertçš„æµ‹è¯•ç»“æœ
```bash
python3 generate_test_results.py --type=bert --start_iter=39 --end_iter=139 --contains=A100-node26
```

## `exporter_util.py`
ç”¨æ¥æå–æŒ‡å®šæœºå™¨ã€æŒ‡å®šæ—¶é—´æ®µå†…çš„æœºå™¨æ€§èƒ½æŒ‡æ ‡ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹`metric_info_dict`æ¥å†³å®šæå–å“ªäº›æŒ‡æ ‡ï¼Œç›®å‰åŒ…æ‹¬ï¼š
```python
metric_info_dict = {
  'DCGM_FI_DEV_FB_USED': (9440, "prod-gpu", 'GPU memory used (in MiB).'),
  'DCGM_FI_DEV_POWER_USAGE': (9440, "prod-gpu", 'GPU power usage (in W).'),
  'DCGM_FI_PROF_GR_ENGINE_ACTIVE': (9440, "prod-gpu", 'GPU utilization (in %).'),
  'node_memory_Committed_AS_bytes': (9100, "prod-node", 'Node Memory information field Committed (in bytes)'),
}
```
è¿™æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œkeyæ˜¯æŒ‡æ ‡çš„åç§°ï¼Œvalueæ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ï¼Œåˆ†åˆ«å¯¹åº”ç€ï¼š
- æŸ¥è¯¢çš„ç«¯å£å·ï¼Œ9440å¯¹åº”çš„æ˜¯GPUç›¸å…³çš„ç«¯å£å·ï¼Œ9100æ˜¯cpuä¸»æœºç›¸å…³çš„ç«¯å£å·
- è¿‡æ»¤ç”¨çš„`job`åå­—ï¼Œå› ä¸ºæŸ¥è¯¢è¿”å›çš„ç»“æœä¸­æœ‰å¥½å‡ ç»„ä¸åŒ`job`çš„ç»“æœï¼Œè™½ç„¶éƒ½ç›¸åŒï¼Œä¸å¦‚è¿‡æ»¤æ‰å†—ä½™çš„å¥½å¤„ç†
- æŒ‡æ ‡çš„ç®€å•è¯´æ˜ï¼ˆæš‚æ—¶æ²¡æœ‰ç”¨ï¼‰

`get_metrics_of_node`è´Ÿè´£éå†`metric_info_dict`ï¼Œç„¶åè°ƒç”¨`get_node_metric`æå–è¿™äº›æŒ‡æ ‡ã€‚

