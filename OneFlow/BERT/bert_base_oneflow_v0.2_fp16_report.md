# BERT base Benchmark Test Report

本报告总结了OneFlow v0.2下BERT base FP16的吞吐率评测。

## Test Environment

所有的测试都是在4台配置8张V100-SXM2-16GB GPU的服务器中进行，主要硬软件配置如下：

- Tesla V100-SXM2-16GB x 8
- InfiniBand 100 Gb/sec (4X EDR)， Mellanox Technologies MT27700 Family
- Intel(R) Xeon(R) Gold 5118 CPU @ 2.30GHz
- Memory 384G
- Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-116-generic x86_64)
- CUDA Version: 10.2, Driver Version: 440.33.01
- OneFlow: v0.1.9 
- OneFlow-Benchmark: master@8a78044
- `nvidia-smi topo -m`

```
        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    mlx5_0  CPU Affinity
GPU0     X      NV1     NV1     NV2     NV2     SYS     SYS     SYS     NODE    0-11,24-35
GPU1    NV1      X      NV2     NV1     SYS     NV2     SYS     SYS     NODE    0-11,24-35
GPU2    NV1     NV2      X      NV2     SYS     SYS     NV1     SYS     PIX     0-11,24-35
GPU3    NV2     NV1     NV2      X      SYS     SYS     SYS     NV1     PIX     0-11,24-35
GPU4    NV2     SYS     SYS     SYS      X      NV1     NV1     NV2     SYS     12-23,36-47
GPU5    SYS     NV2     SYS     SYS     NV1      X      NV2     NV1     SYS     12-23,36-47
GPU6    SYS     SYS     NV1     SYS     NV1     NV2      X      NV2     SYS     12-23,36-47
GPU7    SYS     SYS     SYS     NV1     NV2     NV1     NV2      X      SYS     12-23,36-47
mlx5_0  NODE    NODE    PIX     PIX     SYS     SYS     SYS     SYS      X

Legend:

  X    = Self
  SYS  = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI)
  NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node
  PHB  = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU)
  PXB  = Connection traversing multiple PCIe bridges (without traversing the PCIe Host Bridge)
  PIX  = Connection traversing at most a single PCIe bridge
  NV#  = Connection traversing a bonded set of # NVLinks

```

## Test Descriptions
- OneFlow版本: v0.2，对应commit: [64c20462f245b5cbef4230a62fa06edff85411b3](https://github.com/Oneflow-Inc/oneflow/commit/64c20462f245b5cbef4230a62fa06edff85411b3)
- OneFlow Benchmark仓库: 当前最新master，对应commit：[638d8f42aa064486a4268a388f2bd1e9762c98b3](https://github.com/Oneflow-Inc/OneFlow-Benchmark/commit/638d8f42aa064486a4268a388f2bd1e9762c98b3)
- Data Type: Float16
- XLA: 未采用
- batch size per device: 160 128 64 
- 测试有四组分别使用单机单卡、单机8卡、2机16卡、4机32卡进行测试，每组测试7次，选取这7次数据中的中位数作为最后结果。

全部日志可以点击[bert_base_fp16_b160_128_64_logs.tar](http://oneflow-public.oss-cn-beijing.aliyuncs.com/oneflow_test_log/oneflow_0.2/DLPerf/bert_base_fp16_b160_128_64_logs.tar)获取。

## Test Results

### batch size = 160

本结果是`All Results/OneFlow v0.2 logs`小节中，表格里 `batch_size_per_device=160`提取出来的结果，从每一组7个结果中提取中位数作为最终结果。

| num_nodes | gpu_num_per_node | batch_size_per_device | throughput | speedup |
|-----------|------------------|-----------------------|------------|---------|
| 1 | 1 | 160 | 605.11 | 1.00 |
| 1 | 8 | 160 | 4381.66 | 7.24 |
| 2 | 8 | 160 | 8075.16 | 13.34 |
| 4 | 8 | 160 | 15724.70 | 25.99 |

### batch size = 128

本结果是`All Results/OneFlow v0.2 logs`小节中，表格里 `batch_size_per_device=128`提取出来的结果，从每一组7个结果中提取中位数作为最终结果。

| num_nodes | gpu_num_per_node | batch_size_per_device | throughput | speedup |
|-----------|------------------|-----------------------|------------|---------|
| 1 | 1 | 128 | 589.12 | 1.00 |
| 1 | 8 | 128 | 4179.94 | 7.10 |
| 2 | 8 | 128 | 7673.42 | 13.03 |
| 4 | 8 | 128 | 14729.00 | 25.00 |

### batch size = 64 

本结果是`All Results/OneFlow v0.2 logs`小节中，表格里 `batch_size_per_device=64`提取出来的结果，从每一组7个结果中提取中位数作为最终结果。

| num_nodes | gpu_num_per_node | batch_size_per_device | throughput | speedup |
|-----------|------------------|-----------------------|------------|---------|
| 1 | 1 | 64 | 534.72 | 1.00 |
| 1 | 8 | 64 | 3399.43 | 6.36 |
| 2 | 8 | 64 | 5745.56 | 10.75 |
| 4 | 8 | 64 | 9911.78 | 18.54 |


### All Results
#### OneFlow v0.2 logs
| num_nodes | gpu_num_per_node | batch_size_per_device | throughput |
|-----------|------------------|-----------------------|------------|
| 1 | 1 | 128 | 589.24 |
| 1 | 1 | 128 | 588.34 |
| 1 | 1 | 128 | 588.68 |
| 1 | 1 | 128 | 589.15 |
| 1 | 1 | 128 | 589.38 |
| 1 | 1 | 128 | 589.12 |
| 1 | 1 | 128 | 589.05 |
| 1 | 1 | 160 | 605.11 |
| 1 | 1 | 160 | 604.49 |
| 1 | 1 | 160 | 604.95 |
| 1 | 1 | 160 | 604.92 |
| 1 | 1 | 160 | 605.21 |
| 1 | 1 | 160 | 605.65 |
| 1 | 1 | 160 | 605.23 |
| 1 | 1 | 64 | 534.72 |
| 1 | 1 | 64 | 534.64 |
| 1 | 1 | 64 | 534.82 |
| 1 | 1 | 64 | 533.75 |
| 1 | 1 | 64 | 534.60 |
| 1 | 1 | 64 | 534.77 |
| 1 | 1 | 64 | 534.91 |
| 1 | 1 | 96 | 566.76 |
| 1 | 1 | 96 | 566.35 |
| 1 | 1 | 96 | 566.62 |
| 1 | 1 | 96 | 566.99 |
| 1 | 1 | 96 | 566.91 |
| 1 | 1 | 96 | 566.05 |
| 1 | 1 | 96 | 567.05 |
| 1 | 2 | 128 | 1074.42 |
| 1 | 2 | 128 | 1074.83 |
| 1 | 2 | 128 | 1063.70 |
| 1 | 2 | 128 | 1062.04 |
| 1 | 2 | 128 | 1062.98 |
| 1 | 2 | 128 | 1073.27 |
| 1 | 2 | 128 | 1072.20 |
| 1 | 2 | 160 | 1116.95 |
| 1 | 2 | 160 | 1116.96 |
| 1 | 2 | 160 | 1113.06 |
| 1 | 2 | 160 | 1116.02 |
| 1 | 2 | 160 | 1105.99 |
| 1 | 2 | 160 | 1105.83 |
| 1 | 2 | 160 | 1116.01 |
| 1 | 2 | 64 | 897.62 |
| 1 | 2 | 64 | 894.84 |
| 1 | 2 | 64 | 882.32 |
| 1 | 2 | 64 | 891.77 |
| 1 | 2 | 64 | 894.17 |
| 1 | 2 | 64 | 891.02 |
| 1 | 2 | 64 | 885.33 |
| 1 | 2 | 96 | 999.86 |
| 1 | 2 | 96 | 1002.07 |
| 1 | 2 | 96 | 994.13 |
| 1 | 2 | 96 | 996.92 |
| 1 | 2 | 96 | 1000.93 |
| 1 | 2 | 96 | 994.06 |
| 1 | 2 | 96 | 1003.94 |
| 1 | 4 | 128 | 2149.24 |
| 1 | 4 | 128 | 2124.50 |
| 1 | 4 | 128 | 2141.47 |
| 1 | 4 | 128 | 2126.79 |
| 1 | 4 | 128 | 2110.87 |
| 1 | 4 | 128 | 2115.74 |
| 1 | 4 | 128 | 2108.33 |
| 1 | 4 | 160 | 2239.38 |
| 1 | 4 | 160 | 2238.42 |
| 1 | 4 | 160 | 2240.41 |
| 1 | 4 | 160 | 2211.88 |
| 1 | 4 | 160 | 2228.54 |
| 1 | 4 | 160 | 2204.10 |
| 1 | 4 | 160 | 2214.13 |
| 1 | 4 | 64 | 1786.31 |
| 1 | 4 | 64 | 1790.83 |
| 1 | 4 | 64 | 1792.54 |
| 1 | 4 | 64 | 1776.18 |
| 1 | 4 | 64 | 1797.73 |
| 1 | 4 | 64 | 1773.70 |
| 1 | 4 | 64 | 1785.04 |
| 1 | 4 | 96 | 2001.61 |
| 1 | 4 | 96 | 1979.32 |
| 1 | 4 | 96 | 2016.90 |
| 1 | 4 | 96 | 1998.61 |
| 1 | 4 | 96 | 1976.80 |
| 1 | 4 | 96 | 1983.45 |
| 1 | 4 | 96 | 2003.32 |
| 1 | 8 | 128 | 4191.42 |
| 1 | 8 | 128 | 4174.12 |
| 1 | 8 | 128 | 4128.18 |
| 1 | 8 | 128 | 4203.90 |
| 1 | 8 | 128 | 4195.49 |
| 1 | 8 | 128 | 4165.84 |
| 1 | 8 | 128 | 4179.94 |
| 1 | 8 | 160 | 4381.66 |
| 1 | 8 | 160 | 4381.63 |
| 1 | 8 | 160 | 4389.68 |
| 1 | 8 | 160 | 4385.44 |
| 1 | 8 | 160 | 4384.06 |
| 1 | 8 | 160 | 4359.39 |
| 1 | 8 | 160 | 4362.86 |
| 1 | 8 | 64 | 3377.25 |
| 1 | 8 | 64 | 3414.89 |
| 1 | 8 | 64 | 3428.12 |
| 1 | 8 | 64 | 3413.22 |
| 1 | 8 | 64 | 3399.43 |
| 1 | 8 | 64 | 3346.63 |
| 1 | 8 | 64 | 3390.56 |
| 1 | 8 | 96 | 3827.40 |
| 1 | 8 | 96 | 3893.30 |
| 1 | 8 | 96 | 3907.96 |
| 1 | 8 | 96 | 3898.37 |
| 1 | 8 | 96 | 3890.04 |
| 1 | 8 | 96 | 3843.94 |
| 2 | 8 | 128 | 7647.44 |
| 2 | 8 | 128 | 7669.82 |
| 2 | 8 | 128 | 7693.62 |
| 2 | 8 | 128 | 7674.67 |
| 2 | 8 | 128 | 7658.39 |
| 2 | 8 | 128 | 7706.60 |
| 2 | 8 | 128 | 7673.42 |
| 2 | 8 | 160 | 8150.94 |
| 2 | 8 | 160 | 8116.87 |
| 2 | 8 | 160 | 8118.54 |
| 2 | 8 | 160 | 8067.35 |
| 2 | 8 | 160 | 8075.16 |
| 2 | 8 | 160 | 8060.26 |
| 2 | 8 | 160 | 8049.49 |
| 2 | 8 | 64 | 5736.09 |
| 2 | 8 | 64 | 5736.16 |
| 2 | 8 | 64 | 5785.99 |
| 2 | 8 | 64 | 5788.23 |
| 2 | 8 | 64 | 5712.46 |
| 2 | 8 | 64 | 5775.54 |
| 2 | 8 | 64 | 5745.56 |
| 4 | 8 | 128 | 14727.15 |
| 4 | 8 | 128 | 14709.06 |
| 4 | 8 | 128 | 14730.85 |
| 4 | 8 | 128 | 14838.79 |
| 4 | 8 | 160 | 15773.51 |
| 4 | 8 | 160 | 15724.70 |
| 4 | 8 | 160 | 15723.95 |
| 4 | 8 | 160 | 15743.00 |
| 4 | 8 | 160 | 15647.38 |
| 4 | 8 | 160 | 15762.49 |
| 4 | 8 | 160 | 15651.61 |
| 4 | 8 | 64 | 9935.61 |
| 4 | 8 | 64 | 9911.78 |
| 4 | 8 | 64 | 9945.61 |
| 4 | 8 | 64 | 9810.96 |
| 4 | 8 | 64 | 9872.32 |
| 4 | 8 | 64 | 9952.21 |
| 4 | 8 | 64 | 9875.04 |
